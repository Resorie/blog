<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>模法 | Runtime Error</title>

  
  

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&family=Noto+Sans+SC:wght@100..900&family=Noto+Serif+SC:wght@200..900&family=STIX+Two+Text:ital,wght@0,400..700;1,400..700&family=Ysabeau:ital,wght@0,1..1000;1,1..1000&display=swap" rel="stylesheet"><link rel='stylesheet' href='https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Regular/result.css' />
  <link rel='stylesheet' href='https://chinese-fonts-cdn.deno.dev/packages/syst/dist/SourceHanSerifCN/result.css' />
  <link rel='stylesheet' href='https://unpkg.com/ress/dist/ress.min.css'>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jQuery.mmenu/8.5.10/mmenu.min.css">
  <link rel="stylesheet" href="https://resorie.github.io/blog/style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">

  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      },
      chtml: {
        fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-svg.js"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          const MATH_LANGS = ['math', 'math-display'];

          // 1. Display Math (``` ... ```)
          document.querySelectorAll('pre code').forEach(el => {
              let lang = el.dataset.lang || '';
              if (!lang) {
                  el.classList.forEach(cls => {
                      if (cls.startsWith('language-')) lang = cls.replace('language-', '');
                  });
              }
              
              if (MATH_LANGS.includes(lang.toLowerCase())) {
                  const pre = el.parentElement;
                  const div = document.createElement('div');
                  div.textContent = el.textContent.trim();
                  pre.replaceWith(div);
              }
          });

          // 2. Inline Math (`$ ... $`)
          document.querySelectorAll('code').forEach(el => {
              if (el.parentElement.tagName === 'PRE') return;

              const text = el.textContent.trim();
              // Check if it looks like math: $...$
              if (text.startsWith('$') && text.endsWith('$') && !text.startsWith('$$')) {
                  const span = document.createElement('span');
                  span.textContent = text;
                  el.replaceWith(span);
              }
          });
          
          // Trigger MathJax to process the new elements
          if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
              MathJax.typesetPromise();
          }
      });
  </script>
  

  
<!-- Primary Meta Tags -->
 
<meta
  name="description"
  content="Montgomery Multiplications"
/>

<!-- Open Graph / Facebook -->
<meta property="og:title" content="模法 | Runtime Error" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://resorie.github.io/blog/posts/mogic/" />

<meta property="article:published_time" content="2025-07-23" />
<meta property="article:modified_time" content="2025-07-23" />

<meta property="article:section" content="posts" />
<!--
  
    
      
        <meta property="article:tag" content="数论">
      
        <meta property="article:tag" content="算法">
      
    
  
-->


</head>

<body class="body-block">
  <div id="sidebar-mask" onclick="toggleSidebar()"></div>
  
  <div id="sidebar" class="">
    <div class="logo-title">
      <div class="title-inner">
        
        <div class="avatar">
          <img src="https://resorie.github.io/blog/images/avatar.jpeg" alt="avatar">
        </div>
        
        <div class="title">
          <h3><a href="https://resorie.github.io/blog/">Runtime Error</a></h3>
          <div class="description">
            <p>Resory&#x27;s blog</p>
          </div>
        </div>
      </div>
      <ul class="social-links">
        
        <li>
          <a href="https://github.com/resorie" aria-label="Github">
            <i class="fab fa-github"></i>
          </a>
        </li>
        
        <li>
          <a href="mailto:resorie@qq.com" aria-label="Email">
            <i class="fas fa-envelope"></i>
          </a>
        </li>
        
        <li>
          <a href="https://space.bilibili.com/399133773" aria-label="Bilibili">
            <i class="fab fa-bilibili"></i>
          </a>
        </li>
        
      </ul>
      <div class="sidebar-action">
        <a href="https://resorie.github.io/blog/about/">About Me</a>
      </div>
      <nav class="sidebar-nav">
        <a href="https://resorie.github.io/blog/">Home</a>
        <a href="https://resorie.github.io/blog/posts/">Posts</a>
        <a href="https://resorie.github.io/blog/archive/">Archives</a>
        <a href="https://resorie.github.io/blog/tags/">Categories</a>
        <a href="https://resorie.github.io/blog/links/">Links</a>
      </nav>
    </div>
  </div>
  

  <div id="main">
    
    <div class="page-top animated fadeInDown">
      <nav class="nav">
        <a href="https://resorie.github.io/blog/">Home</a>
        <a href="https://resorie.github.io/blog/posts/" class="active">Posts</a>
        <a href="https://resorie.github.io/blog/about/" >About</a>
        <a href="https://resorie.github.io/blog/archive/" >Archives</a>
        <a href="https://resorie.github.io/blog/tags/" >Categories</a>
        <a href="https://resorie.github.io/blog/links/" >Links</a>
      </nav>
      <div class="information">
        <div class="back_btn">
          <a onclick="window.history.go(-1)" aria-label="Go back"><i class="fas fa-chevron-left"></i></a>
        </div>
        <div class="theme_btn">
          <a onclick="toggleTheme()" aria-label="Toggle theme"><i class="fas fa-moon" id="theme-icon"></i></a>
        </div>
        <div class="feed_btn">
          <a class="feed-icon" aria-label="RSS Feed"><i class="fas fa-rss"></i></a>
          <div class="feed-dropdown">
            <a href="https://resorie.github.io/blog/atom.xml" target="_blank">Atom</a>
            <a href="https://resorie.github.io/blog/rss.xml" target="_blank">RSS</a>
          </div>
        </div>
        <div class="avatar_btn">
          <a onclick="toggleSidebar()" aria-label="Toggle sidebar"><i class="fas fa-bars"></i></a>
        </div>
      </div>
    </div>
    
    <div class="autopagerize_page_element">
      <div class="content animated fadeIn ">
         

<article class="content-article">
  <main class="article-content">
    <div class="article-intro-container">
        <div class="intro-header">
            <h1 class="heading">模法</h1>
            <div class="meta-line">
                
                <span class="date">Jul. 23, 2025</span>
                
                
                
                <span class="separator">/</span>
                <span class="tags">
                
                <a href="https://resorie.github.io/blog/tags/shu-lun/">#数论</a>
                
                <a href="https://resorie.github.io/blog/tags/suan-fa/">#算法</a>
                
                </span>
                
            </div>
        </div>

        <div class="intro-body">
            
            <div class="intro-abstract">
                <div class="abstract-title">ABSTRACT</div>
                <p class="description">Montgomery Multiplications</p>
            </div>
            

            
        </div>
    </div>
    
    <p>因为滚去 whk 鸽了两年的 Montgomery 取模。</p>
<p>众所周知取模很慢，因为一般的除法很慢。但是除一个 <code>$2$</code> 的幂或者对它取模很快。考虑将对固定模数 <code>$p$</code> 的取模转化成对一个 <code>$r=2^k$</code> 的除法和取模操作。要求 <code>$p$</code> 与 <code>$r$</code> 互质，具体使用中 <code>$p$</code> 通常是奇素数，显然满足要求。</p>
<p>由 <code>$p$</code> 与 <code>$r$</code> 互质，<code>$\{xr\mid 0\le x&lt;p\}$</code> 是一个模 <code>$p$</code> 的完全剩余系。考虑用 <code>$r(x)=xr\bmod p$</code> 进行一些操作。</p>
<p>为了快速计算 <code>$r(x)$</code>，考察一个很邪恶的函数。令 <code>$r^{-1}$</code> 为模 <code>$p$</code> 意义下 <code>$r$</code> 的逆元，定义 <code>$redc(x)=xr^{-1}\bmod p$</code>。redc 是 reduce 的缩写，<del>Montgomery 的论文里这么写的</del>。先计算 <code>$redc(x)$</code>。把取模用不定方程替代掉：</p>
<pre class="giallo z-code"><code data-lang="math-display"><span class="giallo-l"><span>$</span><span>$</span></span>
<span class="giallo-l"><span>r</span><span class="z-keyword z-control">\cdot</span><span> redc(x) </span><span class="z-keyword z-operator">+</span><span> kp</span><span class="z-keyword z-operator">=</span><span>x</span></span>
<span class="giallo-l"><span class="z-constant z-character z-escape">\\</span></span>
<span class="giallo-l"><span>redc(x)</span><span class="z-keyword z-operator">=</span><span class="z-keyword z-control">\frac</span><span>{</span><span>x</span><span class="z-keyword z-operator">-</span><span>kp</span><span>}</span><span>{</span><span>r</span><span>}</span></span>
<span class="giallo-l"><span>$</span><span>$</span></span></code></pre>
<p>然后考察 <code>$k$</code>。由 <code>$r$</code> 的性质，自然想到对 <code>$r$</code> 取模：</p>
<pre class="giallo z-code"><code data-lang="math-display"><span class="giallo-l"><span>$</span><span>$</span></span>
<span class="giallo-l"><span>kp</span><span class="z-keyword z-control">\equiv</span><span> x</span><span class="z-keyword z-control">\pmod</span><span> r</span></span>
<span class="giallo-l"><span class="z-constant z-character z-escape">\\</span><span> k</span><span class="z-keyword z-operator">=</span><span>xp</span><span class="z-keyword z-operator">^</span><span>{</span><span class="z-keyword z-operator">-</span><span class="z-constant z-numeric">1</span><span>}</span><span class="z-keyword z-control"> \bmod</span><span> r</span></span>
<span class="giallo-l"><span>$</span><span>$</span></span></code></pre>
<p>由于模数固定，<code>$p^{-1}$</code> 可以预处理。这样算 <code>$redc(x)$</code> 就可以用两次乘法和一些移位搞定了，很快。注意稍微处理一下，保证 <code>$redc(x)\in[0,p)$</code>。于是 <code>$r(x)$</code> 也很好算：<code>$r(x)=redc(xr^2)$</code>。可以预处理一下 <code>$r^2\bmod p$</code>。</p>
<p>接着观测一下 <code>$r(x)$</code> 的性质。显然 <code>$r(x\pm y)=r(x)\pm r(y)$</code>。对乘法有 <code>$r(xy)=\frac{r(x)r(y)}{r}=redc\left(r(x)r(y)\right)$</code>。所以可以直接用 <code>$r(x)$</code> 代替 <code>$x$</code> 进行计算。从 <code>$r(x)$</code> 还原时有 <code>$x=redc(r(x))$</code>。</p>
<p>需要预处理 <code>$p^{-1}\bmod r$</code> 和 <code>$r^2\bmod p$</code>。前者可以对 <code>$f(x)=\dfrac{1}x-p$</code> 牛迭得到，每次令 <code>$x'=2x-x^2p$</code> 即可。后者没啥好办法，直接算吧。</p>
<p>复杂度 <code>$O\left(\dfrac{\log^2p}{w}\right)-O\left(\dfrac{\log^2p}{w^2}\right)$</code>，神速。</p>
<p>贴一下 <a rel="external" href="https://loj.ac/s/316691">zzt 在 Loj#6466 的实现</a>并且稍微解释一下：</p>
<pre class="giallo z-code"><code data-lang="cpp"><span class="giallo-l"><span class="z-storage">struct</span><span class="z-entity z-name z-type"> u256</span><span> {</span></span>
<span class="giallo-l"><span>	u128 lo</span><span class="z-punctuation z-separator z-delimiter">,</span><span> hi</span><span>;</span></span>
<span class="giallo-l"><span class="z-entity z-name z-function">	u256</span><span>(</span><span>)</span><span> {</span><span>}</span></span>
<span class="giallo-l"><span class="z-entity z-name z-function">	u256</span><span>(</span><span class="z-entity z-name z-type">u128</span><span class="z-variable z-parameter z-variable"> lo</span><span class="z-punctuation z-separator z-delimiter">,</span><span class="z-entity z-name z-type"> u128</span><span class="z-variable z-parameter z-variable"> hi</span><span>)</span><span> :</span><span class="z-entity z-name z-function"> lo</span><span>(</span><span>lo</span><span>)</span><span class="z-punctuation z-separator z-delimiter">,</span><span class="z-entity z-name z-function"> hi</span><span>(</span><span>hi</span><span>)</span><span> {</span><span>}</span></span>
<span class="giallo-l"><span class="z-storage">	static</span><span class="z-entity z-name z-type"> u256</span><span class="z-entity z-name z-function"> mul128</span><span>(</span><span class="z-entity z-name z-type">u128</span><span class="z-variable z-parameter z-variable"> a</span><span class="z-punctuation z-separator z-delimiter">,</span><span class="z-entity z-name z-type"> u128</span><span class="z-variable z-parameter z-variable"> b</span><span>)</span><span> {</span></span>
<span class="giallo-l"><span>		u64 a_hi </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span> a </span><span class="z-keyword z-operator z-keyword z-operator z-bitwise z-shift z-cpp">&gt;&gt;</span><span class="z-constant z-numeric"> 64</span><span class="z-punctuation z-separator z-delimiter">,</span><span> a_lo </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span class="z-entity z-name z-function"> u64</span><span>(</span><span>a</span><span>)</span><span>;</span></span>
<span class="giallo-l"><span>		u64 b_hi </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span> b </span><span class="z-keyword z-operator z-keyword z-operator z-bitwise z-shift z-cpp">&gt;&gt;</span><span class="z-constant z-numeric"> 64</span><span class="z-punctuation z-separator z-delimiter">,</span><span> b_lo </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span class="z-entity z-name z-function"> u64</span><span>(</span><span>b</span><span>)</span><span>;</span></span>
<span class="giallo-l"><span>		u128 p01 </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span class="z-entity z-name z-function"> u128</span><span>(</span><span>a_lo</span><span>)</span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp"> *</span><span> b_lo</span><span>;</span></span>
<span class="giallo-l"><span>		u128 p12 </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span class="z-entity z-name z-function"> u128</span><span>(</span><span>a_hi</span><span>)</span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp"> *</span><span> b_lo </span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp">+</span><span class="z-entity z-name z-function"> u64</span><span>(</span><span>p01 </span><span class="z-keyword z-operator z-keyword z-operator z-bitwise z-shift z-cpp">&gt;&gt;</span><span class="z-constant z-numeric"> 64</span><span>)</span><span>;</span></span>
<span class="giallo-l"><span>		u64 t_hi </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span> p12 </span><span class="z-keyword z-operator z-keyword z-operator z-bitwise z-shift z-cpp">&gt;&gt;</span><span class="z-constant z-numeric"> 64</span><span class="z-punctuation z-separator z-delimiter">,</span><span> t_lo </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span> p12</span><span>;</span></span>
<span class="giallo-l"><span>		p12 </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span class="z-entity z-name z-function"> u128</span><span>(</span><span>a_lo</span><span>)</span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp"> *</span><span> b_hi </span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp">+</span><span> t_lo</span><span>;</span></span>
<span class="giallo-l"><span>		u128 p23 </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span class="z-entity z-name z-function"> u128</span><span>(</span><span>a_hi</span><span>)</span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp"> *</span><span> b_hi </span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp">+</span><span class="z-entity z-name z-function"> u64</span><span>(</span><span>p12 </span><span class="z-keyword z-operator z-keyword z-operator z-bitwise z-shift z-cpp">&gt;&gt;</span><span class="z-constant z-numeric"> 64</span><span>)</span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp"> +</span><span> t_hi</span><span>;</span></span>
<span class="giallo-l"><span class="z-keyword z-control">		return</span><span class="z-entity z-name z-function"> u256</span><span>(</span><span class="z-entity z-name z-function">u64</span><span>(</span><span>p01</span><span>)</span><span class="z-keyword z-operator z-keyword z-operator z-bitwise"> |</span><span> (</span><span>p12 </span><span class="z-keyword z-operator z-keyword z-operator z-bitwise z-shift z-cpp">&lt;&lt;</span><span class="z-constant z-numeric"> 64</span><span>)</span><span class="z-punctuation z-separator z-delimiter">,</span><span> p23</span><span>)</span><span>;</span></span>
<span class="giallo-l"><span>	}</span></span>
<span class="giallo-l"><span>}</span><span> ;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage">struct</span><span class="z-entity z-name z-type"> Mont</span><span> {</span></span>
<span class="giallo-l"><span>	u128 mod</span><span class="z-punctuation z-separator z-delimiter">,</span><span> inv</span><span class="z-punctuation z-separator z-delimiter">,</span><span> r2</span><span>;</span></span>
<span class="giallo-l"><span class="z-entity z-name z-function">	Mont</span><span>(</span><span class="z-entity z-name z-type">u128</span><span class="z-variable z-parameter z-variable"> n</span><span>)</span><span> :</span><span class="z-entity z-name z-function"> mod</span><span>(</span><span>n</span><span>)</span><span> {</span></span>
<span class="giallo-l"><span class="z-entity z-name z-function">		assert</span><span>(</span><span>n </span><span class="z-keyword z-operator z-keyword z-operator z-bitwise">&amp;</span><span class="z-constant z-numeric"> 1</span><span>)</span><span>;</span></span>
<span class="giallo-l"><span>		inv </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span> n</span><span>;</span></span>
<span class="giallo-l"><span class="z-keyword z-control">		for</span><span> (</span><span class="z-storage">int</span><span> i </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span class="z-constant z-numeric"> 0</span><span>;</span><span> i </span><span class="z-keyword z-operator z-keyword z-operator z-comparison z-cpp">&lt;</span><span class="z-constant z-numeric"> 6</span><span>;</span><span class="z-keyword z-operator z-keyword z-operator z-increment z-cpp"> ++</span><span>i</span><span>)</span><span> inv </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-compound">*=</span><span class="z-constant z-numeric"> 2</span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp"> -</span><span> n </span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp">*</span><span> inv</span><span>;</span></span>
<span class="giallo-l"><span>		r2 </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp"> -</span><span>n </span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp">%</span><span> n</span><span>;</span></span>
<span class="giallo-l"><span class="z-keyword z-control">		for</span><span> (</span><span class="z-storage">int</span><span> i </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span class="z-constant z-numeric"> 0</span><span>;</span><span> i </span><span class="z-keyword z-operator z-keyword z-operator z-comparison z-cpp">&lt;</span><span class="z-constant z-numeric"> 4</span><span>;</span><span class="z-keyword z-operator z-keyword z-operator z-increment z-cpp"> ++</span><span>i</span><span>)</span><span class="z-keyword z-control"> if</span><span> (</span><span>(</span><span>r2 </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-compound">&lt;&lt;=</span><span class="z-constant z-numeric"> 1</span><span>)</span><span class="z-keyword z-operator z-keyword z-operator z-comparison z-cpp"> &gt;=</span><span> mod</span><span>)</span><span> r2 </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-compound">-=</span><span> mod</span><span>;</span></span>
<span class="giallo-l"><span class="z-keyword z-control">		for</span><span> (</span><span class="z-storage">int</span><span> i </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span class="z-constant z-numeric"> 0</span><span>;</span><span> i </span><span class="z-keyword z-operator z-keyword z-operator z-comparison z-cpp">&lt;</span><span class="z-constant z-numeric"> 5</span><span>;</span><span class="z-keyword z-operator z-keyword z-operator z-increment z-cpp"> ++</span><span>i</span><span>)</span><span> r2 </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span class="z-entity z-name z-function"> mul</span><span>(</span><span>r2</span><span class="z-punctuation z-separator z-delimiter">,</span><span> r2</span><span>)</span><span>;</span></span>
<span class="giallo-l"><span>	}</span></span>
<span class="giallo-l"><span class="z-entity z-name z-type">	u128</span><span class="z-entity z-name z-function"> reduce</span><span>(</span><span class="z-entity z-name z-type">u256</span><span class="z-variable z-parameter z-variable"> x</span><span>)</span><span class="z-storage"> const</span><span> {</span></span>
<span class="giallo-l"><span>		u128 y </span><span class="z-keyword z-operator z-keyword z-operator z-assignment z-cpp">=</span><span class="z-variable z-variable z-other z-object"> x</span><span>.</span><span class="z-variable">hi</span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp"> -</span><span> u256</span><span>::</span><span class="z-entity z-name z-function">mul128</span><span>(</span><span class="z-variable z-variable z-other z-object">x</span><span>.</span><span class="z-variable">lo</span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp"> *</span><span> inv</span><span class="z-punctuation z-separator z-delimiter">,</span><span> mod</span><span>)</span><span>.</span><span class="z-variable">hi</span><span>;</span></span>
<span class="giallo-l"><span class="z-keyword z-control">		return</span><span class="z-entity z-name z-function"> i128</span><span>(</span><span>y</span><span>)</span><span class="z-keyword z-operator z-keyword z-operator z-comparison z-cpp"> &lt;</span><span class="z-constant z-numeric"> 0</span><span class="z-keyword z-operator z-keyword z-operator z-ternary"> ?</span><span> y </span><span class="z-keyword z-operator z-keyword z-operator z-arithmetic z-cpp">+</span><span> mod </span><span class="z-keyword z-operator z-keyword z-operator z-ternary">:</span><span> y</span><span>;</span></span>
<span class="giallo-l"><span>	}</span></span>
<span class="giallo-l"><span class="z-entity z-name z-type">	u128</span><span class="z-entity z-name z-function"> reduce</span><span>(</span><span class="z-entity z-name z-type">u128</span><span class="z-variable z-parameter z-variable"> x</span><span>)</span><span class="z-storage"> const</span><span> {</span><span class="z-keyword z-control"> return</span><span class="z-entity z-name z-function"> reduce</span><span>(</span><span class="z-entity z-name z-function">u256</span><span>(</span><span>x</span><span class="z-punctuation z-separator z-delimiter">,</span><span class="z-constant z-numeric"> 0</span><span>)</span><span>)</span><span>;</span><span> }</span></span>
<span class="giallo-l"><span class="z-entity z-name z-type">	u128</span><span class="z-entity z-name z-function"> init</span><span>(</span><span class="z-entity z-name z-type">u128</span><span class="z-variable z-parameter z-variable"> n</span><span>)</span><span class="z-storage"> const</span><span> {</span><span class="z-keyword z-control"> return</span><span class="z-entity z-name z-function"> reduce</span><span>(</span><span class="z-entity z-name z-scope-resolution z-function z-call">u256</span><span>::</span><span class="z-entity z-name z-function">mul128</span><span>(</span><span>n</span><span class="z-punctuation z-separator z-delimiter">,</span><span> r2</span><span>)</span><span>)</span><span>;</span><span> }</span></span>
<span class="giallo-l"><span class="z-entity z-name z-type">	u128</span><span class="z-entity z-name z-function"> mul</span><span>(</span><span class="z-entity z-name z-type">u128</span><span class="z-variable z-parameter z-variable"> a</span><span class="z-punctuation z-separator z-delimiter">,</span><span class="z-entity z-name z-type"> u128</span><span class="z-variable z-parameter z-variable"> b</span><span>)</span><span class="z-storage"> const</span><span> {</span><span class="z-keyword z-control"> return</span><span class="z-entity z-name z-function"> reduce</span><span>(</span><span class="z-entity z-name z-scope-resolution z-function z-call">u256</span><span>::</span><span class="z-entity z-name z-function">mul128</span><span>(</span><span>a</span><span class="z-punctuation z-separator z-delimiter">,</span><span> b</span><span>)</span><span>)</span><span>;</span><span> }</span></span>
<span class="giallo-l"><span>}</span><span class="z-entity z-name z-function"> mont</span><span>(</span><span class="z-constant z-numeric">1</span><span>)</span><span>;</span></span></code></pre>
<p><code>u256</code> 是一个压位 <code>u128</code>，<code>$x=hi\times2^{128}+lo$</code>。</p>
<p><code>Mont</code> 是 Montgomery 乘法封装成一个结构体。<code>mod</code> 是模数 <code>$p$</code>，<code>inv</code> 是 <code>$p^{-1}\bmod r$</code>，<code>r2</code> 是 <code>$r^2\bmod p$</code>。但是这个 <code>r2</code> 的初始化我没看懂。<code>assert</code> 用来特判偶数，但是这题数据好像没偶数。</p>
<p>使用时先 <code>mont=Mont(p)</code>，每个数都先 <code>x=mont.init(x)</code> 一下。乘法直接 <code>prod=mont.mul(a,b)</code>。还原的时候 <code>mont.reduce</code> 一下自己就行。</p>

  </main>
  <section class="article-action-block">
    <!-- AddToAny BEGIN -->
    <div class="addtoany-block">
      <a
        href="https://www.addtoany.com/share#url=https:&#x2F;&#x2F;resorie.github.io&#x2F;blog&#x2F;posts&#x2F;mogic&#x2F;&amp;title=模法"
        target="_blank"
        rel="noopener noreferrer nofollow"
        ><img class="button" src="https://static.addtoany.com/buttons/a2a.svg"
      /></a>
      <a
        href="https://www.addtoany.com/add_to/mastodon?linkurl=https:&#x2F;&#x2F;resorie.github.io&#x2F;blog&#x2F;posts&#x2F;mogic&#x2F;&amp;linkname=模法"
        target="_blank"
        rel="noopener noreferrer nofollow"
        ><img
          class="button"
          src="https://static.addtoany.com/buttons/mastodon.svg"
      /></a>
      <a
        href="https://www.addtoany.com/add_to/telegram?linkurl=https:&#x2F;&#x2F;resorie.github.io&#x2F;blog&#x2F;posts&#x2F;mogic&#x2F;&amp;linkname=模法"
        target="_blank"
        rel="noopener noreferrer nofollow"
        ><img
          class="button"
          src="https://static.addtoany.com/buttons/telegram.svg"
      /></a>
      <a
        href="https://www.addtoany.com/add_to/twitter?linkurl=https:&#x2F;&#x2F;resorie.github.io&#x2F;blog&#x2F;posts&#x2F;mogic&#x2F;&amp;linkname=模法"
        target="_blank"
        rel="noopener noreferrer nofollow"
        ><img
          class="button"
          src="https://static.addtoany.com/buttons/twitter.svg"
      /></a>
      <a
        href="https://www.addtoany.com/add_to/facebook?linkurl=https:&#x2F;&#x2F;resorie.github.io&#x2F;blog&#x2F;posts&#x2F;mogic&#x2F;&amp;linkname=模法"
        target="_blank"
        rel="noopener noreferrer nofollow"
        ><img
          class="button"
          src="https://static.addtoany.com/buttons/facebook.svg"
      /></a>
      <a
        href="https://www.addtoany.com/add_to/line?linkurl=https:&#x2F;&#x2F;resorie.github.io&#x2F;blog&#x2F;posts&#x2F;mogic&#x2F;&amp;linkname=模法"
        target="_blank"
        rel="noopener noreferrer nofollow"
        ><img class="button" src="https://static.addtoany.com/buttons/line.svg"
      /></a>
    </div>
    <!-- AddToAny END -->
    
  </section>
  <br />
</article>

      </div>
    </div>
    <div class="page-footer">
      <div class="footer-content">
        <span>With theme <a href="https://github.com/Resorie/zola-theme-nivis">Nivis</a><span class="separator">/</span>Powered by <a href="https://www.getzola.org/" target="_blank">Zola</a></span>
      </div>
    </div>
  </div>

  <script>
    function toggleSidebar() {
      var sidebar = document.getElementById("sidebar");
      var mask = document.getElementById("sidebar-mask");
      sidebar.classList.toggle("open");
      mask.classList.toggle("open");
    }

    const getPreferredScheme = () => window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';

    function updateThemeIcon(scheme) {
      const themeIcon = document.getElementById("theme-icon");
      if (themeIcon) {
        if (scheme === 'dark') {
          themeIcon.classList.remove("fa-moon");
          themeIcon.classList.add("fa-sun");
        } else {
          themeIcon.classList.remove("fa-sun");
          themeIcon.classList.add("fa-moon");
        }
      }
    }

    function toggleTheme() {
      const root = document.documentElement;
      const systemScheme = getPreferredScheme();
      const currentInlineScheme = root.style.colorScheme;
      
      // Calculate effective scheme
      const effectiveScheme = currentInlineScheme || systemScheme;
      const targetScheme = effectiveScheme === 'dark' ? 'light' : 'dark';

      root.style.colorScheme = targetScheme;
      localStorage.setItem("theme", targetScheme);
      updateThemeIcon(targetScheme);
    }

    // Initialize theme
    (function() {
      const savedTheme = localStorage.getItem("theme");
      const systemTheme = getPreferredScheme();
      
      if (savedTheme) {
        document.documentElement.style.colorScheme = savedTheme;
        updateThemeIcon(savedTheme);
      } else {
        updateThemeIcon(systemTheme);
      }

      // Listen for system changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem("theme")) {
          const newScheme = e.matches ? 'dark' : 'light';
          updateThemeIcon(newScheme);
        }
      });
    })();

    // Footnote Navigation & Code Block Label
    document.addEventListener("DOMContentLoaded", function() {
        const MATH_LANGS = ['math', 'math-display', 'tex', 'latex'];

        // Code Block Language Label
        document.querySelectorAll('pre code').forEach(code => {
            const pre = code.parentElement;
            let lang = pre.getAttribute('data-lang');

            // 1. Try to recover lang if not on pre
            if (!lang) {
                const codeLang = code.getAttribute('data-lang');
                if (codeLang) {
                    lang = codeLang;
                } else {
                    const classes = code.className.split(' ');
                    for (const cls of classes) {
                        if (cls.startsWith('language-')) {
                            lang = cls.replace('language-', '');
                            break;
                        }
                    }
                }
                if (lang) pre.setAttribute('data-lang', lang);
            }

            // 2. Process Math Blocks
            if (lang && MATH_LANGS.includes(lang.toLowerCase())) {
                const div = document.createElement('div');
                div.classList.add('math-display');
                let mathContent = code.textContent.trim();
                
                // Auto-wrap if typical delimiters are missing
                if (!mathContent.startsWith('$$') && !mathContent.startsWith('\\[')) {
                    mathContent = '$$' + mathContent + '$$';
                }
                
                div.textContent = mathContent;
                pre.replaceWith(div);
            }
        });

        // 3. Process Inline Math
        // Zola (or Markdown) often renders `$E=mc^2$` as <code>$E=mc^2$</code>.
        // We need to unwrap this code tag so MathJax can process it without code styling.
        document.querySelectorAll(':not(pre) > code').forEach(code => {
            const text = code.textContent.trim();
            // Check for $...$ (and not $$...$$) or \(...\)
            if ( (text.startsWith('$') && text.endsWith('$') && !text.startsWith('$$')) ||
                 (text.startsWith('\\(') && text.endsWith('\\)')) ) {
                 const span = document.createElement('span');
                 span.textContent = text;
                 code.replaceWith(span);
            }
        });
    });
  </script>

  <script src="//instant.page/5.1.0" type="module" integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script>
</body>

</html>
